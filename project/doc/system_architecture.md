# 系统架构设计文档

## 架构概述

本电商推荐系统采用模块化、分层式的架构设计，基于物品协同过滤算法，集成了真实分类数据和智能用户偏好建模。系统具有良好的扩展性、可维护性和性能表现。

## 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                   应用层 (Application Layer)                 │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  主控制器   │  │  命令行接口 │  │    Web API接口     │  │
│  │  (Main)     │  │  (CLI)      │  │    (Web API)       │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                   推荐层 (Recommendation Layer)              │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────┐  │
│  │                 推荐生成器 (Recommender)               │  │
│  │  - 个性化推荐        - 混合策略         - 冷启动处理   │  │
│  │  - 推荐解释          - 用户画像         - 质量评估     │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                   模型层 (Model Layer)                       │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────┐  │
│  │                 模型训练器 (ModelTrainer)              │  │
│  │  - 相似度计算       - 矩阵优化        - 模型持久化     │  │
│  │  - 质量评估         - 算法选择        - 统计信息       │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                   处理层 (Processing Layer)                  │
├─────────────────────────────────────────────────────────────┤
│  ┌───────────────────────────────────────────────────────┐  │
│  │             增强数据处理器 (EnhancedDataProcessor)     │  │
│  │  - 数据加载          - 数据清洗        - 数据划分      │  │
│  │  - 矩阵构建          - 分类处理        - 统计监控      │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                   数据层 (Data Layer)                        │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  用户生成器  │  │  商品生成器  │  │   交互生成器        │  │
│  │ (UserGenerator)│ (ItemGenerator)│ (InteractionGenerator)│  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                   存储层 (Storage Layer)                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  数据文件    │  │  模型文件    │  │   配置文件          │  │
│  │  (CSV/JSON) │  │  (NPY/PKL)  │  │    (JSON)          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. 数据层 (Data Layer)

#### 职责
- 生成模拟的用户偏好数据
- 分配商品到真实分类体系
- 生成用户-商品交互数据

#### 关键特性
- **真实分类集成**: 基于真实电商分类体系
- **智能偏好建模**: 模拟不同类型的用户行为
- **交互权重系统**: 区分点击、加购、收藏的不同权重

### 2. 处理层 (Processing Layer)

#### 职责
- 数据加载和清洗
- 训练集/测试集划分
- 用户-物品矩阵构建
- 分类数据处理和统计

#### 关键特性
- **数据质量控制**: 全面的数据验证和清洗
- **时间感知划分**: 按时间顺序划分数据避免泄露
- **稀疏矩阵优化**: 高效处理大规模稀疏数据

### 3. 模型层 (Model Layer)

#### 职责
- 计算物品相似度矩阵
- 模型训练和优化
- 模型持久化和加载
- 质量评估和验证

#### 关键特性
- **多算法支持**: 余弦、皮尔逊、修正余弦相似度
- **内存优化**: 支持大规模矩阵计算
- **质量监控**: 全面的模型统计和验证

### 4. 推荐层 (Recommendation Layer)

#### 职责
- 生成个性化推荐列表
- 用户画像构建和分析
- 推荐解释生成
- 推荐质量评估

#### 关键特性
- **混合策略**: 结合相似度和分类偏好的混合推荐
- **冷启动处理**: 针对新用户的智能推荐策略
- **可解释性**: 为推荐结果提供详细解释
- **全面评估**: 多维度推荐质量评估体系

### 5. 应用层 (Application Layer)

#### 职责
- 系统流程控制和协调
- 命令行接口提供
- Web API服务暴露
- 系统状态监控

#### 关键特性
- **模块化设计**: 各模块独立可替换
- **灵活接口**: 支持多种使用方式
- **状态监控**: 实时系统状态查看

## 数据流设计

### 训练阶段数据流
```
1. 用户生成器 → 用户偏好数据
2. 商品生成器 → 商品分类数据  
3. 交互生成器 → 用户-商品交互数据
4. 数据处理器 → 清洗后的训练数据
5. 数据处理器 → 用户-物品矩阵
6. 模型训练器 → 物品相似度矩阵
7. 模型训练器 → 持久化模型文件
```

### 推荐阶段数据流
```
1. 推荐器 → 加载模型文件
2. 推荐器 → 获取用户历史交互
3. 推荐器 → 生成推荐结果
4. 推荐器 → 提供推荐解释
5. 推荐器 → 评估推荐质量
```

## 配置管理体系

### 1. 核心配置文件 (`config.py`)
```python
# 数据配置
DATA_CONFIG = {
    'num_users': 1000,           # 用户数量
    'num_items': 3000,           # 商品数量
    'num_interactions': 150000,  # 交互数量
    # ... 其他数据参数
}

# 模型配置  
MODEL_CONFIG = {
    'similarity_metric': 'pearson',  # 相似度算法
    'min_similarity': 0.1,          # 最小相似度阈值
    'top_n': 10,                    # 推荐数量
}

# 文件配置
FILE_CONFIG = {
    'interactions_file': 'interactions.csv',
    'items_file': 'items.csv', 
    'similarity_matrix_file': 'similarity_matrix.npy',
    # ... 其他文件路径
}
```

### 2. 分类映射文件 (`category_mapping.json`)
```json
{
    "category_id_1": "分类名称1",
    "category_id_2": "分类名称2",
    # ... 其他分类映射
}
```

## 性能架构设计

### 1. 内存优化策略
- **稀疏矩阵存储**: 使用scipy.sparse矩阵格式
- **分批处理**: 大规模数据分批次处理
- **缓存机制**: 常用数据内存缓存

### 2. 计算优化策略
- **向量化操作**: 使用numpy向量化计算
- **算法选择**: 根据数据特性选择最优算法
- **并行计算**: 支持多进程并行处理

### 3. IO优化策略
- **二进制格式**: 使用npy、pkl等二进制格式
- **批量读写**: 减少IO操作次数
- **压缩存储**: 支持数据压缩存储

## 扩展性设计

### 1. 算法扩展性
- **插件架构**: 支持自定义相似度算法
- **参数配置**: 所有算法参数可配置
- **算法组合**: 支持多种算法组合使用

### 2. 数据扩展性
- **多数据源**: 支持文件、数据库、实时流
- **格式支持**: 支持CSV、JSON、Parquet等格式
- **规模扩展**: 支持从千级到百万级数据规模

### 3. 功能扩展性
- **模块化设计**: 各功能模块独立可替换
- **接口标准化**: 统一的模块接口规范
- **插件机制**: 支持功能插件扩展

## 可靠性设计

### 1. 错误处理
- **异常捕获**: 全面的异常捕获和处理
- **重试机制**: 关键操作支持重试
- **降级策略**: 故障时自动降级处理

### 2. 数据安全
- **数据验证**: 输入数据全面验证
- **备份机制**: 重要数据定期备份
- **恢复策略**: 故障后快速恢复

### 3. 监控告警
- **性能监控**: 关键性能指标监控
- **错误告警**: 异常情况及时告警
- **日志系统**: 完整的操作日志记录

## 部署架构

### 1. 单机部署
```
适用于开发和测试环境
所有模块运行在同一台机器
使用本地文件系统存储
```

### 2. 分布式部署
```
适用于生产环境
模块可分布式部署
使用分布式文件系统
支持负载均衡
```

### 3. 云原生部署
```
适用于云环境
容器化部署
自动扩缩容
高可用设计
```

## 开发规范

### 1. 代码规范
- PEP8代码风格
- 类型注解支持
- 文档字符串完备

### 2. 测试规范
- 单元测试覆盖
- 集成测试完备
- 性能测试定期

### 3. 文档规范
- 模块文档齐全
- API文档完整
- 部署文档详细

该架构设计确保了系统的高性能、高可用性和易扩展性，能够满足不同规模的电商推荐需求。